<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lost & Found Items</title>
    <link rel="stylesheet" href="/css/browse.css" />
    <style>
      /* Additional styles for delete button and enhanced contact */
      .item-card {
        position: relative;
      }
      
      .delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s ease;
        opacity: 0.8;
      }
      
      .delete-btn:hover {
        background: #cc0000;
        opacity: 1;
        transform: scale(1.1);
      }
      
      .contact-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      
      .contact-btn {
        flex: 1;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      
      .contact-phone {
        background: #4CAF50;
        color: white;
         padding: 15px 0;
      }
      
      .contact-phone:hover {
        background: #45a049;
      }
      
      .contact-email {
        background: #005c6d;
        color: white;
        padding: 15px 0;
      }
      
      .contact-email:hover {
        background: #1976D2;
      }
      
      /* Confirmation modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
      }
      
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 1);
        padding: 24px;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        text-align: center;
      }
      
      .modal-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        justify-content: center;
      }
      
      .modal-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }
      
      .modal-btn-cancel {
        background: #ddd;
        color: #333;
      }
      
      .modal-btn-delete {
        background: red;
        color: white;
      }
      
      .modal-btn:hover {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="background">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <!-- <div id="deleteModal" class="modal">
      <div class="modal-content">
        <h3>Delete Item</h3>
        <p>Are you sure you want to delete this item? This action cannot be undone.</p>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
          <button class="modal-btn modal-btn-delete" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div> -->
    
    <div class="container">
      <header class="header">
        <a href="/index.html" class="back-link">Back to Home</a>
        <button class="theme-toggle">‚òÄ</button>
      </header>

      <div class="title-section">
        <h1 class="title">Lost & Found Items</h1>
        <p class="subtitle">
          Browse through reported items and help reunite them with their owners
        </p>
      </div>

      <div class="stats">
        <span class="stat-badge stat-total" id="totalCount">0 Total</span>
        <span class="stat-badge stat-lost" id="lostCount">0 Lost</span>
        <span class="stat-badge stat-found" id="foundCount">0 Found</span>
      </div>

      <div class="search-section">
        <div class="search-bar">
          <span class="search-icon">üîç</span>
          <input
            type="text"
            class="search-input"
            id="searchInput"
            placeholder="Search items by name or description..."
          />
        </div>

        <div class="filter-section">
          <span class="filter-label">Filter by status:</span>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">
              All Items (0)
            </button>
            <button class="filter-btn" data-filter="lost">Lost (0)</button>
            <button class="filter-btn" data-filter="found">Found (0)</button>
          </div>
        </div>
      </div>

      <div class="content-area" id="contentArea">
        <div class="search-icon-large">üîç</div>
        <h2 class="no-items-title">No items found</h2>
        <p class="no-items-subtitle">
          No items have been reported yet. Be the first to report a lost or
          found item!
        </p>
        <button class="report-btn" onclick="reportItem()">
          Report an Item
        </button>
      </div>

      <div class="items-grid" id="itemsGrid" style="display: none"></div>

      <div class="bottom-report-btn">
        <button class="report-btn-bottom" onclick="reportItem()">
          <span>üîç</span>
          Report a New Item
        </button>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        onSnapshot,
        query,
        orderBy,
        doc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDyRmoMB05AqOe7wy3SQvjX4AznHgLeD4I",
        authDomain: "lostandfound-8e40a.firebaseapp.com",
        projectId: "lostandfound-8e40a",
        appId: "1:655253792806:web:a5254918977da0d0d01ee7",
        storageBucket: "lostandfound-8e40a.firebasestorage.app",
        messagingSenderId: "655253792806",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Make Firebase available globally
      window.db = db;
      window.firebaseModules = {
        collection,
        getDocs,
        onSnapshot,
        query,
        orderBy,
        doc,
        deleteDoc,
      };

      // Load items when Firebase is ready
      window.addEventListener("load", () => {
        setTimeout(loadItemsFromFirebase, 1000);
      });
    </script>

    <script>
      // Global variables
      let items = [];
      let filteredItems = [];
      let currentFilter = "all";
      let searchQuery = "";
      let itemToDelete = null;

      // DOM elements
      const searchInput = document.getElementById("searchInput");
      const contentArea = document.getElementById("contentArea");
      const itemsGrid = document.getElementById("itemsGrid");
      const totalCount = document.getElementById("totalCount");
      const lostCount = document.getElementById("lostCount");
      const foundCount = document.getElementById("foundCount");
      const filterButtons = document.querySelectorAll(".filter-btn");
      const deleteModal = document.getElementById("deleteModal");

      // Load items from Firebase
      async function loadItemsFromFirebase() {
        try {
          const { collection, getDocs, query, orderBy } =
            window.firebaseModules;
          const q = query(
            collection(window.db, "items"),
            orderBy("createdAt", "desc")
          );
          const querySnapshot = await getDocs(q);

          items = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            items.push({
              id: doc.id,
              title: data.title,
              description: data.description,
              status: data.status,
              date: data.date,
              location: data.location,
              contactInfo: data.contactInfo,
              imageUrl: data.imageUrl,
              createdAt: data.createdAt,
            });
          });

          updateStats();
          updateFilterButtons();
          filterItems();
        } catch (error) {
          console.error("Error loading items:", error);
        }
      }

      // Real-time listener for items
      function setupRealtimeListener() {
        const { collection, onSnapshot, query, orderBy } =
          window.firebaseModules;
        const q = query(
          collection(window.db, "items"),
          orderBy("createdAt", "desc")
        );

        onSnapshot(q, (querySnapshot) => {
          items = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            items.push({
              id: doc.id,
              title: data.title,
              description: data.description,
              status: data.status,
              date: data.date,
              location: data.location,
              contactInfo: data.contactInfo,
              imageUrl: data.imageUrl,
              createdAt: data.createdAt,
            });
          });

          updateStats();
          updateFilterButtons();
          filterItems();
        });
      }

      // Delete item function
      // async function deleteItem(itemId) {
      //   try {
      //     const { doc, deleteDoc } = window.firebaseModules;
      //     await deleteDoc(doc(window.db, "items", itemId));
      //     console.log("Item deleted successfully");
      //   } catch (error) {
      //     console.error("Error deleting item:", error);
      //     alert("Failed to delete item. Please try again.");
      //   }
      // }

      // Show delete confirmation modal
      // function showDeleteModal(itemId, event) {
      //   event.stopPropagation(); // Prevent card click
      //   itemToDelete = itemId;
      //   deleteModal.style.display = "block";
      // }

      // Close delete confirmation modal
      // function closeDeleteModal() {
      //   deleteModal.style.display = "none";
      //   itemToDelete = null;
      // }

      // Confirm delete action
      // function confirmDelete() {
      //   if (itemToDelete) {
      //     deleteItem(itemToDelete);
      //     closeDeleteModal();
      //   }
      // }

      // Determine contact type and return contact info
      function getContactInfo(contactInfo) {
        if (!contactInfo) return null;
        
        const cleanContact = contactInfo.trim();
        
        // More robust email detection
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        
        // More flexible phone detection (supports various formats)
        const phoneRegex = /^[\+]?[\d\s\-\(\)]{7,20}$/;
        
        if (emailRegex.test(cleanContact)) {
          return { type: 'email', value: cleanContact };
        } else if (cleanContact.includes('@')) {
          // If it contains @ but doesn't match strict regex, still treat as email
          return { type: 'email', value: cleanContact };
        } else if (phoneRegex.test(cleanContact) || /^\d{10,15}$/.test(cleanContact.replace(/[\s\-\(\)]/g, ''))) {
          return { type: 'phone', value: cleanContact };
        } else {
          // Default fallback - if it looks more like a number, treat as phone
          const numbersOnly = cleanContact.replace(/[^\d]/g, '');
          if (numbersOnly.length >= 7) {
            return { type: 'phone', value: cleanContact };
          } else {
            return { type: 'email', value: cleanContact };
          }
        }
      }

      // Handle contact button click
      function handleContact(contactInfo, contactType) {
        if (contactType === 'email') {
          window.location.href = `mailto:${contactInfo}`;
        } else if (contactType === 'phone') {
          window.location.href = `tel:${contactInfo}`;
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        searchInput.addEventListener("input", handleSearch);

        filterButtons.forEach((btn) => {
          btn.addEventListener("click", handleFilter);
        });

        // Theme toggle
        document
          .querySelector(".theme-toggle")
          .addEventListener("click", toggleTheme);
          
        // Close modal when clicking outside
        deleteModal.addEventListener("click", (e) => {
          if (e.target === deleteModal) {
            closeDeleteModal();
          }
        });
      }

      // Handle search functionality
      function handleSearch(e) {
        searchQuery = e.target.value.toLowerCase();
        filterItems();
      }

      // Handle filter functionality
      function handleFilter(e) {
        currentFilter = e.target.dataset.filter;

        filterButtons.forEach((btn) => btn.classList.remove("active"));
        e.target.classList.add("active");

        filterItems();
      }

      // Filter items based on search and filter criteria
      function filterItems() {
        filteredItems = items.filter((item) => {
          const matchesSearch =
            item.title.toLowerCase().includes(searchQuery) ||
            item.description.toLowerCase().includes(searchQuery) ||
            item.location.toLowerCase().includes(searchQuery);

          const matchesFilter =
            currentFilter === "all" || item.status === currentFilter;

          return matchesSearch && matchesFilter;
        });

        renderItems();
      }

      // Update statistics
      function updateStats() {
        const total = items.length;
        const lost = items.filter((item) => item.status === "lost").length;
        const found = items.filter((item) => item.status === "found").length;

        totalCount.textContent = `${total} Total`;
        lostCount.textContent = `${lost} Lost`;
        foundCount.textContent = `${found} Found`;
      }

      // Update filter button counts
      function updateFilterButtons() {
        const total = items.length;
        const lost = items.filter((item) => item.status === "lost").length;
        const found = items.filter((item) => item.status === "found").length;

        filterButtons.forEach((btn) => {
          const filter = btn.dataset.filter;
          if (filter === "all") {
            btn.textContent = `All Items (${total})`;
          } else if (filter === "lost") {
            btn.textContent = `Lost (${lost})`;
          } else if (filter === "found") {
            btn.textContent = `Found (${found})`;
          }
        });
      }

      // Render items
      function renderItems() {
        if (filteredItems.length === 0) {
          contentArea.style.display = "flex";
          itemsGrid.style.display = "none";

          if (searchQuery || currentFilter !== "all") {
            contentArea.innerHTML = `
              <div class="search-icon-large">üîç</div>
              <h2 class="no-items-title">No items match your search</h2>
              <p class="no-items-subtitle">Try adjusting your search terms or filters to find what you're looking for.</p>
              <button class="report-btn" onclick="clearSearch()">Clear Search</button>
            `;
          } else {
            contentArea.innerHTML = `
              <div class="search-icon-large">üîç</div>
              <h2 class="no-items-title">No items found</h2>
              <p class="no-items-subtitle">No items have been reported yet. Be the first to report a lost or found item!</p>
              <button class="report-btn" onclick="reportItem()">Report an Item</button>
            `;
          }
        } else {
          contentArea.style.display = "none";
          itemsGrid.style.display = "grid";

          itemsGrid.innerHTML = filteredItems
            .map((item) => {
              const contactInfo = getContactInfo(item.contactInfo);
              const contactButton = contactInfo ? 
                `<div class="contact-buttons">
                  <button class="contact-btn contact-${contactInfo.type}" onclick="handleContact('${contactInfo.value}', '${contactInfo.type}')">
                    ${contactInfo.type === 'email' ? 'üìß' : 'üìû'} Contact via ${contactInfo.type === 'email' ? 'Email' : 'Phone'}
                  </button>
                </div>` : '';
              
              return `
                <div class="item-card" onclick="viewItem('${item.id}')">
                  <button class="delete-btn" onclick="showDeleteModal('${item.id}', event)" title="Delete item">√ó</button>
                  <span class="item-status status-${item.status}">${item.status.toUpperCase()}</span>
                  <h3 class="item-title">${item.title}</h3>
                  <p class="item-description">${item.description}</p>
                  ${item.imageUrl ? 
                    `<img src="${item.imageUrl}" alt="${item.title}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin: 10px 0;">` : 
                    ''
                  }
                  <div class="item-meta">
                    <span>${item.location}</span>
                    <span>${formatDate(item.date)}</span>
                  </div>
                  ${contactButton}
                </div>
              `;
            })
            .join("");
        }
      }

      // Format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      // Clear search and filters
      function clearSearch() {
        searchInput.value = "";
        searchQuery = "";
        currentFilter = "all";

        filterButtons.forEach((btn) => btn.classList.remove("active"));
        filterButtons[0].classList.add("active");

        filterItems();
      }

      // View item details
      function viewItem(id) {
        const item = items.find((i) => i.id === id);
        if (item) {
          const contactInfo = getContactInfo(item.contactInfo);
          const contactDisplay = contactInfo ? 
            `\nContact: ${item.contactInfo} (${contactInfo.type})` : 
            `\nContact: ${item.contactInfo}`;
          const imageDisplay = item.imageUrl ? `\n\n[Image Available]` : "";
          // alert(
          //   `Item Details:\n\nTitle: ${item.title}\nStatus: ${item.status.toUpperCase()}\nLocation: ${item.location}\nDate: ${item.date}${contactDisplay}\n\nDescription: ${item.description}${imageDisplay}`
          // );
        }
      }

      // Report new item
      function reportItem() {
        window.location.href = "report.html";
      }

      // Initialize the page
      function init() {
        updateStats();
        updateFilterButtons();
        renderItems();
        setupEventListeners();

        // Setup real-time listener when Firebase is available
        if (window.firebaseModules) {
          setupRealtimeListener();
        }
      }

      // Toggle theme
      function toggleTheme() {
        document.body.classList.toggle("light-theme");
        const toggle = document.querySelector(".theme-toggle");
        toggle.textContent = document.body.classList.contains("light-theme")
          ? "üåô"
          : "‚òÄ";
      }

      // Initialize the page
      init();
    </script>
  </body>
</html>