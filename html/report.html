<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Item - Lost & Found</title>
    <link rel="stylesheet" href="/css/report.css" />
  </head>
  <body>
    <div class="background">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
      <div class="spinner">
        <div></div>   
        <div></div>    
        <div></div>    
        <div></div>    
        <div></div>    
        <div></div>    
        <div></div>    
        <div></div>    
        <div></div>    
        <div></div>    
      </div>
    </div>

    <!-- Unauthorized access modal -->
    <div id="unauthorized-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px; margin: 20px;">
        <div style="font-size: 48px; margin-bottom: 20px;">üîí</div>
        <h2 style="margin-bottom: 15px; color: #333;">Authentication Required</h2>
        <p style="margin-bottom: 25px; color: #666;">You need to be logged in to report items. Please sign in to continue.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="redirectToLogin()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Sign In</button>
          <button onclick="goBack()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Go Back</button>
        </div>
      </div>
    </div>

    <div class="form-container" id="main-content" style="display: none;">
      <div class="header">
        <a href="browse.html" class="back-link">
          <span>‚Üê</span>
          Back to Browse Items
        </a>
        <h1 class="title">Item Status</h1>
        <p class="subtitle">Is this a lost or found item?</p>
      </div>

      <div class="status-toggle">
        <div class="toggle-option">
          <div
            class="toggle-checkbox"
            id="lostToggle"
            onclick="toggleStatus('lost')"
          ></div>
          <span>Lost</span>
        </div>
        <div class="toggle-option">
          <div
            class="toggle-checkbox checked"
            id="foundToggle"
            onclick="toggleStatus('found')"
          ></div>
          <span>Found</span>
        </div>
      </div>

      <form id="reportForm">
        <div class="success-message" id="successMessage">
          Item reported successfully! You will be redirected to the browse page.
        </div>

        <div class="error-message" id="errorMessage">
          Please fill in all required fields.
        </div>

        <div class="form-group">
          <label class="form-label" for="itemName">
            Item Name<span class="required">*</span>
          </label>
          <input
            type="text"
            id="itemName"
            class="form-input"
            placeholder="e.g iPhone 13, Blue Backpack, Car Keys"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="description">
            Description<span class="required">*</span>
          </label>
          <textarea
            id="description"
            class="form-textarea"
            placeholder="Provide detailed description including color, brand, distinctive features, etc."
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label class="form-label" for="dateInput">
            Date Lost<span class="required">*</span>
          </label>
          <div class="date-input">
            <input type="date" id="dateInput" class="form-input" required />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="location">
            Location<span class="required">*</span>
          </label>
          <input
            type="text"
            id="location"
            class="form-input"
            placeholder="Where was it lost/found?"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="imageUpload">
            Item Image
            <span class="optional-text">(optional if not available)</span>
          </label>
          <div class="file-input-container">
            <input
              type="file"
              id="imageUpload"
              class="file-input-hidden"
              accept="image/*"
            />
            <div
              class="file-input"
              onclick="document.getElementById('imageUpload').click()"
              id="fileInputDisplay"
            >
              Choose File | No file chosen
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="contactInfo">
            Contact Information<span class="required">*</span>
          </label>
          <input
            type="text"
            id="contactInfo"
            class="form-input"
            placeholder="Email address or phone number"
            required
          />
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          Submit Report
        </button>
      </form>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDyRmoMB05AqOe7wy3SQvjX4AznHgLeD4I",
        authDomain: "lostandfound-8e40a.firebaseapp.com",
        projectId: "lostandfound-8e40a",
        appId: "1:655253792806:web:a5254918977da0d0d01ee7",
        storageBucket: "lostandfound-8e40a.firebasestorage.app",
        messagingSenderId: "655253792806",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();

      let currentUser = null;
      let currentStatus = "found";
      let selectedFile = null;

      // Check authentication on page load
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        const loadingOverlay = document.getElementById('loading-overlay');
        const unauthorizedModal = document.getElementById('unauthorized-modal');
        const mainContent = document.getElementById('main-content');

        loadingOverlay.style.display = 'none';

        if (user) {
          // User is authenticated, show the form
          mainContent.style.display = 'block';
          init();
        } else {
          // User is not authenticated, show unauthorized modal
          unauthorizedModal.style.display = 'flex';
        }
      });

      // Redirect functions
      function redirectToLogin() {
        window.location.href = '/html/loginandsignup.html';
      }

      function goBack() {
        window.history.back();
        window.location.href = '/index.html';
      }

      // Initialize form
      function init() {
        // Set today's date as default
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("dateInput").value = today;

        // Update date label based on status
        updateDateLabel();

        // Setup file input handler
        document
          .getElementById("imageUpload")
          .addEventListener("change", handleFileSelect);

        // Setup form submission
        document
          .getElementById("reportForm")
          .addEventListener("submit", handleSubmit);
      }

      // Toggle between lost and found status
      function toggleStatus(status) {
        currentStatus = status;

        const lostToggle = document.getElementById("lostToggle");
        const foundToggle = document.getElementById("foundToggle");

        if (status === "lost") {
          lostToggle.classList.add("checked");
          foundToggle.classList.remove("checked");
        } else {
          foundToggle.classList.add("checked");
          lostToggle.classList.remove("checked");
        }

        updateDateLabel();
      }

      // Update date label based on status
      function updateDateLabel() {
        const dateLabel = document.querySelector('label[for="dateInput"]');
        const labelText = currentStatus === "lost" ? "Date Lost" : "Date Found";
        dateLabel.innerHTML = `${labelText}<span class="required">*</span>`;
      }

      // Handle file selection
      function handleFileSelect(event) {
        const file = event.target.files[0];
        const display = document.getElementById("fileInputDisplay");

        if (file) {
          selectedFile = file;
          display.textContent = `Choose File | ${file.name}`;
        } else {
          selectedFile = null;
          display.textContent = "Choose File | No file chosen";
        }
      }

      // Handle form submission
      async function handleSubmit(event) {
        event.preventDefault();

        if (!currentUser) {
          alert('You must be logged in to report items.');
          return;
        }

        const submitBtn = document.getElementById("submitBtn");
        const successMsg = document.getElementById("successMessage");
        const errorMsg = document.getElementById("errorMessage");

        // Hide previous messages
        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        // Get form data
        const formData = {
          status: currentStatus,
          itemName: document.getElementById("itemName").value.trim(),
          description: document.getElementById("description").value.trim(),
          date: document.getElementById("dateInput").value,
          location: document.getElementById("location").value.trim(),
          contactInfo: document.getElementById("contactInfo").value.trim(),
          image: selectedFile,
        };

        // Validate required fields
        if (
          !formData.itemName ||
          !formData.description ||
          !formData.date ||
          !formData.location ||
          !formData.contactInfo
        ) {
          errorMsg.style.display = "block";
          return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        try {
          await submitToFirebase(formData);

          // Show success message
          successMsg.style.display = "block";

          // Reset form
          document.getElementById("reportForm").reset();
          selectedFile = null;
          document.getElementById("fileInputDisplay").textContent =
            "Choose File | No file chosen";

          // Redirect after delay
          setTimeout(() => {
            window.location.href = "/browse.html";
          }, 2000);
        } catch (error) {
          console.error("Error submitting form:", error);
          errorMsg.textContent = "Error submitting report. Please try again.";
          errorMsg.style.display = "block";
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Report";
        }
      }

      // Submit to Firebase
      async function submitToFirebase(formData) {
        let imageUrl = null;

        // Upload image if provided
        if (formData.image) {
          const imageRef = storage.ref(`item-images/${Date.now()}-${formData.image.name}`);
          const snapshot = await imageRef.put(formData.image);
          imageUrl = await snapshot.ref.getDownloadURL();
        }

        // Create item document
        const itemData = {
          title: formData.itemName,
          description: formData.description,
          status: formData.status,
          date: formData.date,
          location: formData.location,
          contactInfo: formData.contactInfo,
          imageUrl: imageUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          userId: currentUser.uid,
          userEmail: currentUser.email,
          userName: currentUser.displayName || currentUser.email.split('@')[0],
          id: Date.now().toString(),
        };

        // Add to Firestore
        const docRef = await db.collection("items").add(itemData);
        console.log("Document written with ID: ", docRef.id);

        return docRef;
      }
    </script>
  </body>
</html>